{% extends 'base.html' %}

{% block title %}Platformer — Suldee{% endblock %}

{% block content %}
  <section>
    <h2>Platformer (Python in the browser)</h2>
      <section>
        <h2>Platformer (Python in the browser)</h2>
        <p>Use arrow keys or A/D to move, space to jump. Switch levels and toggle fullscreen.</p>
        <div id="game-wrap" style="display:block; margin:12px 0;">
          <canvas id="game" width="800" height="400" style="border:1px solid #ccc; background: #cfe8ff; display:block;"></canvas>
          <div style="margin-top:8px;">
            <button id="prev-level">Prev Level</button>
            <button id="next-level">Next Level</button>
            <button id="fs-btn">Enter Fullscreen</button>
          </div>
        </div>

        <p>Also: <a href="https://platformpanic.com" target="_blank">Platform Panic</a></p>
      </section>

      <script>
      // small WebAudio helper exposed for Brython to play effects
      function playSound(freq, duration, type){
        try{
          const C = window.AudioContext || window.webkitAudioContext;
          const ctx = new C();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type || 'sine';
          o.frequency.value = freq || 440;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          g.gain.setValueAtTime(0.1, ctx.currentTime);
          setTimeout(()=>{ o.stop(); ctx.close(); }, duration || 120);
        }catch(e){/* ignore if audio blocked */}
      }
      window.playSound = playSound;

      // fullscreen toggle helper
      function toggleFullscreen(elem, btn){
        if(!document.fullscreenElement){
          elem.requestFullscreen?.();
          btn.textContent = 'Exit Fullscreen';
        } else {
          document.exitFullscreen?.();
          btn.textContent = 'Enter Fullscreen';
        }
      }
      window.toggleFullscreen = toggleFullscreen;
      </script>

      <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js"></script>
      <script type="text/python">
    from browser import document, window, timer

    canvas = document['game']
    wrap = document['game-wrap']
    ctx = canvas.getContext('2d')

    W, H = 800, 400

    player = {'x':50, 'y':H-90, 'w':40, 'h':60, 'vx':0, 'vy':0, 'on_ground':False}
    gravity = 1.0
    keys = {'left':False, 'right':False, 'up':False}

    # load images
    PlayerImg = window.Image.new()
    PlayerImg.src = "/static/images/player.svg"
    EnemyImg = window.Image.new()
    EnemyImg.src = "/static/images/enemy.svg"
    TileImg = window.Image.new()
    TileImg.src = "/static/images/tile.svg"

    # multiple levels: list of platform lists
    levels = [
        [
            {'x':0, 'y':H-20, 'w':W, 'h':20},
            {'x':120, 'y':300, 'w':120, 'h':16},
            {'x':300, 'y':230, 'w':120, 'h':16},
            {'x':520, 'y':170, 'w':150, 'h':16},
        ],
        [
            {'x':0, 'y':H-20, 'w':W, 'h':20},
            {'x':80, 'y':260, 'w':100, 'h':16},
            {'x':220, 'y':200, 'w':80, 'h':16},
            {'x':360, 'y':140, 'w':160, 'h':16},
            {'x':560, 'y':220, 'w':120, 'h':16},
        ],
        [
            {'x':0, 'y':H-20, 'w':W, 'h':20},
            {'x':150, 'y':320, 'w':160, 'h':16},
            {'x':350, 'y':260, 'w':160, 'h':16},
            { 'x':550, 'y':200, 'w':200, 'h':8716},
        ]
    ]
    level_index = 0
    platforms = levels[level_index]

    enemies = [ {'x':420, 'y':140, 'w':40, 'h':40, 'dir':1} ]

    def set_level(idx):
        global platforms, level_index
        level_index = idx % len(levels)
        platforms = levels[level_index]
        # reset player
        player['x'], player['y'] = 50, H-90
        player['vx'] = player['vy'] = 0

    def keydown(ev):
        k = ev.key
        if k in ('ArrowLeft','a'):
            keys['left'] = True
        if k in ('ArrowRight','d'):
            keys['right'] = True
        if k in (' ','Spacebar','Space'):
            keys['up'] = True

    def keyup(ev):
        k = ev.key
        if k in ('ArrowLeft','a'):
            keys['left'] = False
        if k in ('ArrowRight','d'):
            keys['right'] = False
        if k in (' ','Spacebar','Space'):
            keys['up'] = False

    document.bind('keydown', keydown)
    document.bind('keyup', keyup)

    def coll(a, b):
        return not (a['x']+a['w'] < b['x'] or a['x'] > b['x']+b['w'] or a['y']+a['h'] < b['y'] or a['y'] > b['y']+b['h'])

    def update():
        # horizontal
        if keys['left']:
            player['vx'] = -5
        elif keys['right']:
            player['vx'] = 5
        else:
            player['vx'] *= 0.85

        player['x'] += player['vx']

        # gravity
        player['vy'] += gravity
        player['y'] += player['vy']

        # collisions
        prev_on_ground = player['on_ground']
        player['on_ground'] = False
        for p in platforms:
            if coll(player, p):
                if player['vy'] > 0 and player['y'] + player['h'] - player['vy'] <= p['y']:
                    player['y'] = p['y'] - player['h']
                    player['vy'] = 0
                    player['on_ground'] = True
                    if not prev_on_ground:
                        # landed
                        window.playSound(260, 80)

        # jump
        if keys['up'] and player['on_ground']:
            player['vy'] = -16
            player['on_ground'] = False
            window.playSound(880, 120)

        # bounds
        if player['x'] < 0: player['x'] = 0
        if player['x'] + player['w'] > W: player['x'] = W - player['w']
        if player['y'] > H+200: # fell far
            player['x'], player['y'] = 50, H-90
            player['vx'] = player['vy'] = 0

        # enemies simple patrol
        for e in enemies:
            e['x'] += e['dir'] * 1.2
            if e['x'] < 0 or e['x'] + e['w'] > W:
                e['dir'] *= -1
            # check if enemy hurts player
            if coll(player, e):
                window.playSound(100, 200)  # hurt sound
                set_level(level_index)  # reset level

    def draw():
        ctx.clearRect(0,0,W,H)
        # draw background gradient
        g = ctx.createLinearGradient(0,0,0,H)
        g.addColorStop(0, '#cfe8ff')
        g.addColorStop(1, '#9ed0ff')
        ctx.fillStyle = g
        ctx.fillRect(0,0,W,H)

        # draw platforms using tile image repeated
        for p in platforms:
            try:
                # draw tiled image across platform width
                tw = TileImg.width or 128
                x = p['x']
                while x < p['x'] + p['w']:
                    ctx.drawImage(TileImg, x, p['y'], min(tw, p['x']+p['w']-x), p['h'])
                    x += tw
            except Exception:
                ctx.fillStyle = '#6b8e23'
                ctx.fillRect(p['x'], p['y'], p['w'], p['h'])

        # draw player image
        try:
            ctx.drawImage(PlayerImg, player['x'], player['y'], player['w'], player['h'])
        except Exception:
            ctx.fillStyle = '#ff5722'
            ctx.fillRect(player['x'], player['y'], player['w'], player['h'])

        # draw enemies
        for e in enemies:
            try:
                ctx.drawImage(EnemyImg, e['x'], e['y'], e['w'], e['h'])
            except Exception:
                ctx.fillStyle = '#8b0000'
                ctx.fillRect(e['x'], e['y'], e['w'], e['h'])

        # HUD
        ctx.fillStyle = '#000'
        ctx.fillText(f'Level: {level_index+1}/{len(levels)} — Use arrows or A/D, Space to jump', 10, 18)

    def tick():
        update()
        draw()

    timer.set_interval(tick, 16)

    # level controls
    def next_level(ev=None):
        set_level(level_index+1)

    def prev_level(ev=None):
        set_level(level_index-1)

    document['next-level'].bind('click', next_level)
    document['prev-level'].bind('click', prev_level)

    # fullscreen toggle
    def fs_toggle(ev=None):
        window.toggleFullscreen(wrap, document['fs-btn'])

    document['fs-btn'].bind('click', fs_toggle)

      </script>
      <script>
        // start brython after page loads
        window.addEventListener('load', function(){ brython(); });
      </script>
{% endblock %}
